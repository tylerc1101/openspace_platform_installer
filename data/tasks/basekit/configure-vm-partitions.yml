---
- name: Expand disk partition and logical volumes
  hosts: target_hosts
  become: yes
  gather_facts: yes
  
  vars:
    disk_device: /dev/vda
    partition_number: 3
    vg_name: vg_root
    
    # LV expansion percentages
    lv_expansions:
      - { name: lv_log, percent: 4, mount: /var/log }
      - { name: lv_vmp, percent: 4, mount: /var/tmp }
      - { name: lv_audit, percent: 4, mount: /var/log/audit }
      - { name: lv_tmp, percent: 5, mount: /tmp }
      - { name: lv_home, percent: 25, mount: /home }
      - { name: lv_var, percent: 50, mount: /var }
      - { name: lv_root, percent: 100, mount: / }

  tasks:
    - name: Get current partition information
      command: parted {{ disk_device }} unit MB print
      register: partition_info
      changed_when: false

    - name: Extract partition start location
      set_fact:
        partition_start: "{{ partition_info.stdout | regex_search('\\s+' + partition_number|string + '\\s+(\\d+\\.?\\d*)MB', '\\1') | first }}"

    - name: Display partition start (for verification)
      debug:
        msg: "Partition {{ partition_number }} starts at {{ partition_start }}MB"

    - name: Remove existing partition
      parted:
        device: "{{ disk_device }}"
        number: "{{ partition_number }}"
        state: absent

    - name: Create new partition using all available space
      parted:
        device: "{{ disk_device }}"
        number: "{{ partition_number }}"
        state: present
        part_start: "{{ partition_start }}MB"
        part_end: "100%"
        flags: [ lvm ]

    - name: Inform kernel of partition changes
      command: partprobe {{ disk_device }}

    - name: Resize physical volume
      command: pvresize {{ disk_device }}{{ partition_number }}

    - name: Get volume group information
      command: vgs --noheadings -o vg_free {{ vg_name }}
      register: vg_info
      changed_when: false

    - name: Display free space
      debug:
        msg: "Free space in {{ vg_name }}: {{ vg_info.stdout | trim }}"

    - name: Extend logical volumes
      command: "lvextend -l +{{ item.percent }}%FREE /dev/{{ vg_name }}/{{ item.name }}"
      loop: "{{ lv_expansions }}"
      register: lv_extend_result
      failed_when: 
        - lv_extend_result.rc != 0
        - "'matches existing size' not in lv_extend_result.stderr"

    - name: Grow XFS filesystems
      command: "xfs_growfs {{ item.mount }}"
      loop: "{{ lv_expansions }}"
      when: item.mount is defined

    - name: Verify filesystem sizes
      command: df -h
      register: df_output
      changed_when: false

    - name: Display filesystem sizes
      debug:
        var: df_output.stdout_lines