- name: Setup {{ target_hosts }} for cluster deployment
  hosts: "{{ target_hosts }}"
  become: yes
  vars:
    env_dir: "/docker-workspace/config/{{ env_name }}"

  tasks:

    - name: Ensure certificate directory exists
      ansible.builtin.file:
        path: "/etc/pki/ca-trust/source/anchors/"
        state: directory
        mode: '0755'

    - name: Deploy CA certificate
      ansible.builtin.copy:
        src: "{{ env_dir }}/generated_files/.cache/cacerts.pem"
        dest: "/etc/pki/ca-trust/source/anchors/cacerts.pem"
        mode: '0644'
      register: cert_copy_result

    - name: Update CA trust store
      ansible.builtin.command:
        cmd: update-ca-trust extract
      changed_when: false
      when: cert_copy_result.changed

    - name: Check if secret exists
      ansible.builtin.command:
        cmd: kubectl get secret -n openspace-system {{ cluster_ssh_key }}
      register: get_secret
      changed_when: false
      failed_when: get_secret.rc not in [0,1]

    - name: Create secret if not found
      ansible.builtin.command:
        cmd: >
          kubectl create secret generic -n openspace-system {{ cluster_ssh_key }}
          --type=opaque
          --from-literal=username={{ ansible_host }}
          --from-file=sshKey={{ ssh_key_path }}
      when: get_secret.rc != 0