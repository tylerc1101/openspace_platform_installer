- name: Prep Onboarder Container
  hosts: "{{ target_hosts | default('localhost')}}"
  vars:
    env_name: "{{ env_name | mandatory }}"
    config_dir: "/docker-workspace/config"
    env_dir: "{{ config_dir }}/{{ env_name }}"
    sample_vsphere_dir: "{{ config_dir }}/sample-vsphere"
    cache_dir: "{{ env_dir }}/.cache"
    ssh_user: "{{ ansible_user }}"
    common_dir: "{{ config_dir }}/common"
  
  tasks:
    # a) Build directories
    - name: Ensure .cache directory exists
      file:
        path: "{{ cache_dir }}"
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Write resolv.conf in-place (unsafe)
      ansible.builtin.copy:
        content: |
          nameserver 192.168.2.1
        dest: /etc/resolv.conf
        owner: root
        group: root
        mode: '0644'
        unsafe_writes: true

    # b) Modify Makefiles
    - name: Deploy Makefile
      template:
        src: /install/data/templates/basekit_makefile.j2
        dest: "{{ env_dir }}/Makefile"
        owner: root
        group: root
        mode: '0644'

    - name: Modify common Makefile inside container
      lineinfile:
        path: "{{ common_dir }}/Makefile"
        regexp: "{{ item.regexp }}"
        line: "{{ item.replacement }}"
        backrefs: yes
      loop:
        - { regexp: '^(SSH_USERNAME\s*\?=).*',      replacement: '\1 {{ ssh_user }}' }
        - { regexp: '^(SSH_KEY_FILE_NAME\s*\?=).*', replacement: '\1 rancher_ssh_key' }
        - { regexp: '^(VM_NIC_INTERFACE\s*\?=).*',  replacement: '\1 enp1s0' }

    # c) Create terraform state file
    - name: Create vm-terraform.tfstate inside container
      template:
        src: /install/data/templates/basekit_vm-terraform.tfstate.j2
        dest: "{{ cache_dir }}/vm-terraform.tfstate"
        owner: root
        group: root
        mode: '0644'

    # d) Copy SSH Key into cache dir
    - name: Copy ssh_key into .cache directory
      copy:
        src: "/docker-workspace/config/{{ env_name }}/.ssh/rancher_ssh_key"
        dest: "{{ cache_dir }}/rancher_ssh_key"
        owner: root
        group: root
        mode: '0600'

    # e) Fix cilium bug
    - name: Disable Cilium encryption in valuesContent block
      ansible.builtin.replace:
        path: /docker-workspace/scripts/init-rke2-ansible/gen_ansible_inventory.sh
        # Match 'encryption:' â€¦ then the specific 'enabled: true' before 'type: wireguard'
        regexp: '(?ms)^(\s*encryption:\s*\n\s*enabled:\s*)true(?=\s*\n\s*type:\s*wireguard)'
        replace: '\1false'