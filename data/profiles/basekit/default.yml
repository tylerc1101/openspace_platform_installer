# Base-Kit Default Profile
# This profile deploys a management KVM server and creates VMs for OpenSpace infrastructure
# All configuration comes from usr_home/{env}/group_vars/

metadata:
  name: "Base-Kit Default"
  version: "1.0.0"
  description: "Deploys management KVM server with MCM, OSMS, and OPNsense VMs"
  profile_kind: basekit
  
requirements:
  # Inventory must have these host groups
  inventory_groups:
    - mgmt_kvm
    - vms
  
  # Environment files that must exist
  files:
    - "/install/usr_home/{env}/.ssh/onboarder_ssh_key.pub"

steps:
  - id: copy_ssh_key
    description: "Copy SSH Key to mgmt_kvm"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/common/copy_ssh_key.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true

  - id: bootstrap_mgmt_kvm
    description: "Bootstrap Mgmt KVM"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/bootstrap-mgmt-kvm.yml"
    on_failure: fail
    required: true
    timeout: 1800

  - id: deploy_vms
    description: "Deploy VMs"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/deploy-vms.yml"
    on_failure: fail
    required: true
    timeout: 3600

  - id: configure_nodes
    description: "Configure Node"
    hosts:
      - mcm
      - osms
    kind: ansible
    file: "tasks/common/configure-node.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 1800

# TODO
#  - id: generate_opnsense_config
#    description: "Generate OPNsense Configuration"
#    kind: ansible
#    file: "tasks/basekit/generate-opnsense-config.yml"
#    args:
#      - "-e env_name={env}"
#    on_failure: fail
#    required: true
#    timeout: 300

  - id: configure_opnsense_config
    description: "Configure OPNsense config.xml"
    hosts: 
      - localhost
    kind: ansible
    file: "tasks/basekit/configure-opnsense.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 600

  - id: copy_opnsense_config
    description: "Copy OPNsense config.xml to mgmt_kvm"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/copy-opnsense-config.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 600

  - id: deploy_opnsense
    description: "Deploy OPNsense"
    hosts: 
      - mgmt_kvm
    iterate: false
    kind: command
    command: "bash /var/lib/libvirt/config/vm_config/opnsense/opnsense_install.sh"
    on_failure: fail
    required: true
    timeout: 1800

#  - id: Kratos Power Scripts (step 15 in instructions)