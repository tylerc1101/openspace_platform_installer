# ==============================================================================
# Environment Taskfile - GENERATED FILE
# ==============================================================================
# ⚠️  DO NOT EDIT THIS FILE MANUALLY
#
# This file is GENERATED from: deployment.yml
# To make changes:
#   1. Edit deployment.yml
#   2. Run: task prep-config
#   3. This file will be regenerated
#
# Generated: {{ ansible_date_time.iso8601 }}
# Deployment: {{ deployment.name }}
# ==============================================================================

{% set data_dir = "/docker-workspace/data" %}

version: '3'

includes:
  deployment:
    taskfile: '{{ data_dir }}/deployments/{{ deployment.type }}/{{ deployment.version }}/main.yml'
    vars:
      DATA_DIR: '{{ data_dir }}'
      DEPLOYMENT_DIR: '{{ data_dir }}/deployments/{{ deployment.type }}/{{ deployment.version }}'
      INSTALL_DIR: '{{ install_dir }}'
  
  onboarder:
    taskfile: '{{ data_dir }}/onboarders/{{ deployment.onboarder_version }}/main.yml'

tasks:
  # ============================================================================
  # Deployment Tasks
  # ============================================================================
  deploy-infra:
    desc: "Deploys {{ deployment.type }} infrastructure"
    cmds:
      - task: deployment:deploy-all

  deploy-mcm:
    desc: "Deploy MCM (Management Cluster Manager)"
    cmds:
      - task: onboarder:deploy-mcm
    vars:
      HOSTS: management_cluster

  deploy-osms:
    desc: "Deploy OSMS (OpenSpace Management System)"
    cmds:
      - task: onboarder:deploy-osms
    vars:
      HOSTS: openspace_management_system

  deploy-osdc:
    desc: "Deploy OSDC (OpenSpace Data Cluster)"
    cmds:
      - task: onboarder:deploy-osdc
    vars:
      HOSTS: openspace_datapath_cluster

  deploy-all:
    desc: "Deploy all clusters (MCM → OSMS → OSDC)"
    cmds:
      - task: deploy-infra
      - task: deploy-mcm
      - task: deploy-osms
      - task: deploy-osdc

  # ============================================================================
  # Cleanup Tasks
  # ============================================================================
  clean:
    desc: "Clean up deployment artifacts"
    cmds:
      - task: deploy:clean

  clean-config:
    desc: "Remove all generated configuration files"
    prompt: "This will delete all generated config files. Continue?"
    cmds:
      - rm -f config.yml
      - rm -f Taskfile.yml
      - rm -rf group_vars/
      - rm -rf host_vars/
      - rm -rf .cache/generated/
      - echo "✓ Generated configuration files removed"
      - echo "Run 'task prep-config' to regenerate"

  # ============================================================================
  # Utility Tasks
  # ============================================================================
  shell:
    desc: "Open a shell in the onboarder container"
    cmds:
      - task: deploy:shell

  logs:
    desc: "Show deployment logs"
    cmds:
      - cat .cache/state.json | python3 -m json.tool

  help:
    desc: "Show this help message"
    cmds:
      - task --list

# ==============================================================================
# Common Commands Quick Reference
# ==============================================================================
#
# Configuration:
#   task prep-config         - Regenerate configs from deployment.yml
#   task validate-config     - Validate generated configs
#   task show-config         - Show config summary
#
# Deployment:
#   task prep                - Complete environment preparation
#   task deploy-mcm          - Deploy MCM cluster
#   task deploy-osms         - Deploy OSMS cluster
#   task deploy-osdc         - Deploy OSDC cluster
#   task deploy-all          - Deploy all clusters
#
# Utilities:
#   task shell               - Open container shell
#   task logs                - View logs
#   task clean               - Clean deployment artifacts
#
# ==============================================================================
