---
- name: Expand disk partition and logical volumes (using growpart)
  hosts: "{{ target_hosts }}"
  become: yes
  gather_facts: yes
  
  vars:
    disk_device: /dev/vda
    partition_number: 3
    vg_name: vg_root
    
    lv_expansions:
      - { name: lv_log, percent: 4, mount: /var/log }
      - { name: lv_vmp, percent: 4, mount: /var/tmp }
      - { name: lv_audit, percent: 4, mount: /var/log/audit }
      - { name: lv_tmp, percent: 5, mount: /tmp }
      - { name: lv_home, percent: 25, mount: /home }
      - { name: lv_var, percent: 50, mount: /var }
      - { name: lv_root, percent: 100, mount: / }

  tasks:
    - name: Install cloud-utils-growpart if not present
      package:
        name: cloud-utils-growpart
        state: present
      when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"
      disable_gpg_check: yes


    - name: Grow partition to use all available space
      command: growpart {{ disk_device }} {{ partition_number }}
      register: growpart_result
      failed_when:
        - growpart_result.rc != 0
        - "'NOCHANGE' not in growpart_result.stdout"
      changed_when: "'CHANGED' in growpart_result.stdout"

    - name: Resize physical volume
      command: pvresize {{ disk_device }}{{ partition_number }}

    - name: Get volume group information
      command: vgs --noheadings -o vg_free {{ vg_name }}
      register: vg_info
      changed_when: false

    - name: Display free space
      debug:
        msg: "Free space in {{ vg_name }}: {{ vg_info.stdout | trim }}"

    - name: Extend logical volumes
      command: "lvextend -l +{{ item.percent }}%FREE /dev/{{ vg_name }}/{{ item.name }}"
      loop: "{{ lv_expansions }}"
      register: lv_extend_result
      failed_when: 
        - lv_extend_result.rc != 0
        - "'matches existing size' not in lv_extend_result.stderr"

    - name: Grow XFS filesystems
      command: "xfs_growfs {{ item.mount }}"
      loop: "{{ lv_expansions }}"

    - name: Verify filesystem sizes
      command: df -h
      register: df_output
      changed_when: false

    - name: Display filesystem sizes
      debug:
        var: df_output.stdout_lines