# Base-Kit Default Deployment
# This deployment deploys a management KVM server and creates VMs for OpenSpace infrastructure
# All configuration comes from environments/{env}/group_vars/

metadata:
  name: "Base-Kit Default"
  version: "1.0.0"
  description: "Deploys management KVM server with MCM, OSMS, and OPNsense VMs"
  deployment_type: basekit
  
requirements:
  # Inventory must have these host groups
  inventory_groups:
    - mgmt_kvm
    - vms
  
  # Environment files that must exist
  files:
    - "/docker-workspace/config/{env}/.ssh/onboarder_ssh_key.pub"

steps:
  - id: copy_mgmt_kvm_ssh_key
    description: "Copy SSH Key to mgmt_kvm"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/common/copy_ssh_key.yml"
    args:
      - "-e env_name={env}"
      - "-e ssh_pubkey_path=/docker-workspace/config/{env}/.ssh/onboarder_ssh_key.pub"
    on_failure: fail
    required: true

  - id: bootstrap_mgmt_kvm
    description: "Bootstrap Mgmt KVM"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/bootstrap-mgmt-kvm.yml"
    on_failure: fail
    required: true
    timeout: 1800

  - id: deploy_vms
    description: "Deploy VMs"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/deploy-vms.yml"
    on_failure: fail
    required: true
    timeout: 3600

  - id: configure_nodes
    description: "Configure Node"
    hosts:
      - mcm
      - osms
      #- osdc1
      #- osdc2
    kind: ansible
    file: "tasks/common/configure-node.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 1800

  - id: install_rke2_selinux
    description: "Install RKE2 SELinux Package"
    hosts:
      - mcm
      - osms
    kind: ansible
    file: "tasks/common/install_rke2-selinux.yml"
    args:
    on_failure: fail
    required: true
    timeout: 600

  - id: configure_opnsense_config
    description: "Configure OPNsense config.xml"
    hosts: 
      - localhost
    kind: ansible
    file: "tasks/basekit/configure-opnsense.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 600

  - id: copy_opnsense_config
    description: "Copy OPNsense config.xml to mgmt_kvm"
    hosts: 
      - mgmt_kvm
    kind: ansible
    file: "tasks/basekit/copy-opnsense-config.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 600

  - id: deploy_opnsense
    description: "Deploy OPNsense"
    hosts: 
      - mgmt_kvm
    iterate: false
    kind: command
    command: "sudo bash /var/lib/libvirt/config/vm_config/opnsense/opnsense_install.sh"
    on_failure: fail
    required: true
    timeout: 1800

  - id: prep_onboarder_container
    description: "Prep Onboarder Container"
    hosts: 
      - localhost
    kind: ansible
    file: "tasks/common/prep_onboarder_container.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 600

  - id: copy_mcm_ssh_key
    description: "Copy SSH Key to MCM"
    hosts: 
      - mcm
    kind: ansible
    file: "tasks/common/copy_ssh_key.yml"
    args:
      - "-e env_name={env}"
      - "-e ssh_pubkey_path=/docker-workspace/config/{env}/.ssh/rancher_ssh_key.pub"
    on_failure: fail
    required: true

  - id: deploy_rke2_cluster
    description: "Deploy RKE2 Cluster"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace ansible-deploy-rke2-cluster ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: bootstrap_container_images
    description: "Bootstrap Container Images"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace bootstrap-container-images-run ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: deploy_harbor
    description: "Deploy Harbor to the cluster"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace helmfile-install HELMFILE_CHART=harbor ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: load_darksite_bundles
    description: "Load Darksite Bundles"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace load-darksite-bundles ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: deploy_rancher
    description: "Deploy Rancher to the cluster"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace helmfile-install HELMFILE_CHART=rancher ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: terraform_rancher
    description: "Terraform Rancher Configuration"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace terraform-rancher-bootstrap-apply ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 1800

  - id: deploy_gitea
    description: "Deploy Gitea to the cluster"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace install-gitea ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: deploy_argocd
    description: "Deploy ArgoCD to the cluster"
    hosts: 
      - localhost
    kind: command
    command: "make -C /docker-workspace install-argocd ENVIRONMENT={env}/generated_files"
    on_failure: fail
    required: true
    timeout: 3600

  - id: deploy_clusters
    description: "Deploy OpenSpace Clusters"
    hosts:
      - localhost
    kind: ansible
    file: "tasks/common/deploy_clusters.yml"
    args:
      - "-e env_name={env}"
    on_failure: fail
    required: true
    timeout: 3600

  #- id: deploy_opscenter
  #  description: "Deploy OpsCenter to the OSMS cluster"
  #  hosts: 
  #    - localhost
  #  kind: command
  #  command: ""
  #  on_failure: fail
  #  required: true
  #  timeout: 3600

#  - id: Kratos Power Scripts (step 15 in instructions)