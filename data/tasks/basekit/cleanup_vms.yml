---
- name: Cleanup OpenSpace VMs
  hosts: mgmt_kvm
  become: yes
  
  tasks:
    - name: Get list of VMs to remove
      ansible.builtin.set_fact:
        vms_to_remove:
          - mcm
          - osms
          - osdc-provisioner

    - name: Stop VMs if running
      ansible.builtin.command: virsh destroy {{ item }}
      loop: "{{ vms_to_remove }}"
      ignore_errors: yes
      changed_when: false

    - name: Undefine VMs and remove storage
      ansible.builtin.command: virsh undefine {{ item }} --nvram --remove-all-storage
      loop: "{{ vms_to_remove }}"
      ignore_errors: yes
      register: undefine_result
      changed_when: "'undefined' in undefine_result.stdout"

    - name: Remove any leftover disk images
      ansible.builtin.file:
        path: "/var/lib/libvirt/images/{{ item }}.qcow2"
        state: absent
      loop: "{{ vms_to_remove }}"

    - name: Remove cloud-init ISOs
      ansible.builtin.file:
        path: "/var/lib/libvirt/config/cloud-init/{{ item }}/{{ item }}-cloud-init.iso"
        state: absent
      loop:
        - mcm
        - osms

    - name: Verify VMs are removed
      ansible.builtin.shell: virsh list --all --name
      register: remaining_vms
      changed_when: false

    - name: Display remaining VMs
      ansible.builtin.debug:
        msg: "Remaining VMs: {{ remaining_vms.stdout_lines }}"