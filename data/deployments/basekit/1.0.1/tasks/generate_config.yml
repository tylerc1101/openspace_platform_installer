---
# ==============================================================================
# OpenSpace Platform - Configuration Generator
# ==============================================================================
# This playbook generates all configuration files from a single deployment.yml
# It also manages SSH key generation and validation
# ==============================================================================

- name: Generate deployment configuration files
  hosts: localhost
  gather_facts: yes
  
  vars:
    env_name: "{{ env_name | mandatory }}"
    env_dir: "/docker-workspace/config/install"
    deployment_config: "{{ env_dir }}/deployment.yml"
    ssh_dir: "{{ env_dir }}/.ssh"
    templates_dir: "/docker-workspace/data/deployments/{{ deployment_type }}/{{ deployment_version }}/templates"
  
  tasks:
    # ==========================================================================
    # PHASE 1: Load and Validate Source Config
    # ==========================================================================
    - name: "PHASE 1: Load and Validate Configuration"
      debug:
        msg: "Loading deployment configuration from {{ deployment_config }}"
    
    - name: Check if deployment.yml exists
      stat:
        path: "{{ deployment_config }}"
      register: deployment_config_stat
      failed_when: not deployment_config_stat.stat.exists
    
    - name: Load deployment configuration
      include_vars:
        file: "{{ deployment_config }}"
        name: config
    
    - name: Display loaded configuration
      debug:
        msg: "âœ“ Loaded configuration for deployment: {{ config.deployment.name }}"
    
    - name: Validate required fields in deployment.yml
      assert:
        that:
          - config.deployment is defined
          - config.deployment.name is defined
          - config.deployment.type is defined
          - config.deployment.version is defined
          - config.ssh is defined
          - config.ssh.user is defined
          - config.ssh.keys is defined
          - config.networks is defined
          - config.clusters is defined
          - config.clusters.management_cluster is defined
          - config.clusters.management_cluster.clusters is defined
          - config.infrastructure is defined
        fail_msg: "deployment.yml is missing required fields"
        success_msg: "âœ“ All required fields present in deployment.yml"
    
    - name: Set deployment type and version for templates
      set_fact:
        deployment_type: "{{ config.deployment.type }}"
        deployment_version: "{{ config.deployment.version }}"
    
    # ==========================================================================
    # PHASE 2: Create Directory Structure
    # ==========================================================================
    - name: "PHASE 2: Directory Structure"
      debug:
        msg: "Creating configuration directory structure"
    
    - name: Ensure group_vars directory exists
      file:
        path: "{{ env_dir }}/group_vars"
        state: directory
        mode: '0755'
    
    - name: Ensure host_vars directory exists
      file:
        path: "{{ env_dir }}/host_vars"
        state: directory
        mode: '0755'
    
    - name: Ensure cache directory exists
      file:
        path: "{{ env_dir }}/.cache/generated"
        state: directory
        mode: '0755'

    - name: Ensure .ssh directory exists
      file:
        path: "{{ ssh_dir }}"
        state: directory
        mode: '0700'
    
    # ==========================================================================
    # PHASE 3: Generate Ansible Inventory
    # ==========================================================================
    - name: "PHASE 3: Generate Ansible Inventory"
      debug:
        msg: "Generating inventory.yml from template"
    
    - name: Generate Ansible inventory (inventory.yml)
      template:
        src: "{{ templates_dir }}/inventory.yml.j2"
        dest: "{{ env_dir }}/inventory.yml"
        mode: '0644'
      vars:
        deployment: "{{ config.deployment }}"
        ssh: "{{ config.ssh }}"
        networks: "{{ config.networks }}"
        domain: "{{ config.domain }}"
        ntp: "{{ config.ntp }}"
        infrastructure: "{{ config.infrastructure }}"
        clusters: "{{ config.clusters }}"
        vips: "{{ config.vips | default({}) }}"
    
    # ==========================================================================
    # PHASE 4: Generate group_vars Files
    # ==========================================================================
    - name: "PHASE 4: Generate group_vars"
      debug:
        msg: "Generating group_vars files from templates"
    
    - name: Generate group_vars/all.yml
      template:
        src: "{{ templates_dir }}/group_vars_all.yml.j2"
        dest: "{{ env_dir }}/group_vars/all.yml"
        mode: '0644'
      vars:
        deployment: "{{ config.deployment }}"
        networks: "{{ config.networks }}"
        domain: "{{ config.domain }}"
        ntp: "{{ config.ntp }}"
        vips: "{{ config.vips | default({}) }}"
        storage: "{{ config.storage | default({}) }}"
    
    - name: Generate group_vars/deployment.yml
      template:
        src: "{{ templates_dir }}/group_vars_deployment.yml.j2"
        dest: "{{ env_dir }}/group_vars/deployment.yml"
        mode: '0644'
      vars:
        deployment: "{{ config.deployment }}"
        vips: "{{ config.vips | default({}) }}"
        clusters: "{{ config.clusters }}"
    
    # ==========================================================================
    # PHASE 5: Generate host_vars Files
    # ==========================================================================
    - name: "PHASE 5: Generate host_vars"
      debug:
        msg: "Generating host_vars files from templates"
    
    - name: Generate host_vars/mgmt_kvm.yml
      template:
        src: "{{ templates_dir }}/host_vars_mgmt_kvm.yml.j2"
        dest: "{{ env_dir }}/host_vars/mgmt_kvm.yml"
        mode: '0644'
      vars:
        mgmt_kvm: "{{ config.infrastructure.mgmt_kvm }}"
        networks: "{{ config.networks }}"
    
    # ==========================================================================
    # PHASE 6: Generate Taskfile (optional)
    # ==========================================================================
    - name: "PHASE 6: Generate Taskfile"
      debug:
        msg: "Generating Taskfile.yml from template"
    
    - name: Check if Taskfile template exists
      stat:
        path: "{{ templates_dir }}/taskfile.yml.j2"
      register: taskfile_template
    
    - name: Generate Taskfile.yml
      template:
        src: "{{ templates_dir }}/taskfile.yml.j2"
        dest: "{{ env_dir }}/Taskfile.yml"
        mode: '0644'
      vars:
        deployment: "{{ config.deployment }}"
        clusters: "{{ config.clusters }}"
      when: taskfile_template.stat.exists
    
    # ==========================================================================
    # PHASE 7: Validation
    # ==========================================================================
    - name: "PHASE 7: Validate Generated Files"
      debug:
        msg: "Validating generated configuration files"
    
    - name: Validate generated config.yml syntax
      command: ansible-inventory -i {{ env_dir }}/config.yml --list
      register: inventory_validation
      changed_when: false
      failed_when: inventory_validation.rc != 0
    
    - name: Validate generated group_vars YAML syntax
      command: python3 -c "import yaml; yaml.safe_load(open('{{ item }}'))"
      loop:
        - "{{ env_dir }}/group_vars/all.yml"
        - "{{ env_dir }}/group_vars/deployment.yml"
      changed_when: false
    
    # ==========================================================================
    # SUCCESS SUMMARY
    # ==========================================================================
    - name: Display success summary
      debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         Configuration Generation Completed Successfully!           â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“ Environment Directory: {{ env_dir }}
          
          âœ… Generated Files:
             â€¢ config.yml              (Ansible inventory)
             â€¢ group_vars/all.yml      (Global variables)
             â€¢ group_vars/deployment.yml (Deployment variables)
             â€¢ host_vars/mgmt_kvm.yml  (Management KVM host vars)
             {% if taskfile_template.stat.exists %}â€¢ Taskfile.yml            (Task runner config){% endif %}

          
          ğŸ”‘ SSH Keys: {{ ssh_dir }}/
          {% for key_name, key_file in config.ssh.keys.items() %}
             â€¢ {{ key_name }}: {{ key_file }}
          {% endfor %}
          
          ğŸ“‹ Source: {{ deployment_config }}
          
          âš ï¸  IMPORTANT:
             All generated files are marked as GENERATED - DO NOT EDIT
             To make changes, edit deployment.yml and run 'task prep-config'
          
          ğŸš€ Next Steps:
             1. Review generated files in {{ env_dir }}
             2. If SSH keys were generated, deploy public keys to target hosts
             3. Run: task prep
             4. Run: task deploy-mcm
          
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
