---
- name: Create OpenSpace VMs
  hosts: mgmt_kvm
  become: yes
  vars:
    images_dir: /var/lib/libvirt/config/images
    cloud_init_dir: /var/lib/libvirt/config/cloud-init

  tasks:
    # Pre-flight checks
    - name: Ensure libvirt config directory exists
      ansible.builtin.file:
        path: /var/lib/libvirt/config
        state: directory
        mode: '0755'

    - name: Check if base-kit archive variable is defined
      ansible.builtin.fail:
        msg: "Variable 'basekit' is not defined in group_vars"
      when: basekit is not defined

    - name: Copy base-kit config files
      ansible.builtin.copy:
        src: "/install/images/{{ basekit }}/config/"
        dest: "/var/lib/libvirt/config"
        remote_src: no

    - name: Set correct permissions on all images in images directory
      ansible.builtin.file:
        path: "{{ images_dir }}"
        owner: qemu
        group: qemu
        mode: '0644'
        recurse: yes

    - name: Set correct permissions on images directory
      ansible.builtin.file:
        path: "{{ images_dir }}"
        owner: qemu
        group: qemu
        mode: '0755'
        recurse: no

    - name: Check if hardened image exists
      ansible.builtin.stat:
        path: "{{ images_dir }}/9_5_hardened_image_vm.qcow2"
      register: hardened_image_stat
      failed_when: not hardened_image_stat.stat.exists

    - name: Get list of existing VMs
      ansible.builtin.shell: virsh list --all --name
      register: existing_vms
      changed_when: false

    # ---------- MCM ----------
    - name: Check if MCM VM already exists
      ansible.builtin.set_fact:
        mcm_exists: "{{ 'mcm' in existing_vms.stdout_lines }}"

    - name: Create VM - MCM
      ansible.builtin.command:
        cmd: >
          virt-install
          --name mcm
          --memory {{ vm_mcm_memory | default(16384) }}
          --vcpus {{ vm_mcm_vcpus | default(8) }}
          --cpu host-passthrough
          --disk size=600,backing_store="{{ images_dir}}/9_5_hardened_image_vm.qcow2"
          --cloud-init user-data="{{ cloud_init_dir }}/mcm/user-data",meta-data="{{ cloud_init_dir }}/mcm/meta-data",network-config="{{ cloud_init_dir }}/mcm/network-config"
          --os-variant rhel9.5
          --network bridge=br-mgmt,model=virtio
          --import
          --autostart
          --noautoconsole
          --graphics vnc
          --boot uefi
      when: not mcm_exists
      register: mcm_result

    # ---------- OSMS ----------
    - name: Check if OSMS VM already exists
      ansible.builtin.set_fact:
        osms_exists: "{{ 'osms' in existing_vms.stdout_lines }}"

    - name: Create VM - OSMS
      ansible.builtin.command:
        cmd: >
          virt-install
          --name osms
          --memory {{ vm_osms_memory | default(32768) }}
          --vcpus {{ vm_osms_vcpus | default(16) }}
          --cpu host-passthrough
          --disk size=600,backing_store="{{ images_dir}}/9_5_hardened_image_vm.qcow2"
          --cloud-init user-data="{{ cloud_init_dir }}/osms/user-data",meta-data="{{ cloud_init_dir }}/osms/meta-data",network-config="{{ cloud_init_dir }}/osms/network-config"
          --os-variant rhel9.5
          --network bridge=br-mgmt,model=virtio
          --import
          --autostart
          --noautoconsole
          --graphics vnc
          --boot uefi
      when: not osms_exists
      register: osms_result

    # ---------- OSDC provisioner ----------
    - name: Check if OSDC provisioner VM already exists
      ansible.builtin.set_fact:
        osdc_exists: "{{ 'osdc-provisioner' in existing_vms.stdout_lines }}"

    - name: Check if Rocky ISO exists
      ansible.builtin.stat:
        path: "{{ images_dir }}/Rocky-9.4-x86_64-dvd.iso"
      register: rocky_iso_stat

    - name: Create VM - OSDC provisioner
      ansible.builtin.command:
        cmd: >
          virt-install
          --name osdc-provisioner
          --memory {{ vm_osdc_memory | default(6144) }}
          --vcpus {{ vm_osdc_vcpus | default(4) }}
          --cpu host-passthrough
          --disk size=100
          --location {{ images_dir }}/Rocky-9.4-x86_64-dvd.iso,initrd=isolinux/initrd.img,kernel=isolinux/vmlinuz
          --initrd-inject /var/lib/libvirt/config/vm_config/osdc/prov_vm_ks.cfg
          --extra-args="inst.ks=file:/prov_vm_ks.cfg console=tty0"
          --os-variant=rocky9
          --network bridge=br-iDRAC,model=virtio
          --noautoconsole
          --noautostart
      when: 
        - not osdc_exists
        - rocky_iso_stat.stat.exists
      register: osdc_result

    - name: Summary of VM operations
      ansible.builtin.debug:
        msg:
          - "MCM: {{ 'created' if mcm_result is changed else 'already exists' }}"
          - "OSMS: {{ 'created' if osms_result is changed else 'already exists' }}"
          - "OSDC: {{ 'created' if (osdc_result is changed) else ('already exists' if osdc_exists else 'skipped - ISO missing') }}"