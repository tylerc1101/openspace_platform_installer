---
- name: Create OpenSpace VMs
  hosts: "{{ target_hosts | default('mgmt_kvm') }}"
  become: yes
  vars:
    images_dir: /var/lib/libvirt/config/images
    
    # Extract MCM node configuration from inventory
    mcm_node: "{{ management_cluster.clusters[0].nodes[0] }}"
    mcm_network_cidr_prefix: "{{ networks.management.cidr | regex_replace('^/', '') }}"
    
    # Extract OSMS node configuration from inventory
    osms_node: "{{ openspace_management_system.clusters[0].nodes[0] }}"

  tasks:
    # Pre-flight checks

    - name: Check if hardened image exists
      ansible.builtin.stat:
        path: "{{ images_dir }}/9_5_hardened_image_vm.qcow2"
      register: hardened_image_stat
      failed_when: not hardened_image_stat.stat.exists

    - name: Get list of existing VMs
      ansible.builtin.shell: virsh list --all --name
      register: existing_vms
      changed_when: false

    # ---------- MCM ----------
    - name: Check if MCM VM already exists
      ansible.builtin.set_fact:
        mcm_exists: "{{ vm_mcm_name in existing_vms.stdout_lines }}"

    - name: Create VM - MCM
      ansible.builtin.command:
        cmd: >
          virt-install
          --name {{ vm_mcm_name }}
          --memory {{ vm_mcm_memory }}
          --vcpus {{ vm_mcm_vcpus }}
          --cpu host-passthrough
          --disk size={{ vm_mcm_disk_size }},backing_store="{{ images_dir}}/9_5_hardened_image_vm.qcow2"
          --os-variant rhel9.5
          --network bridge=br-mgmt,model=virtio
          --import
          --noautoconsole
          --graphics vnc
          --boot uefi
          --print-xml
      register: mcm_xml
      when: not mcm_exists

    - name: Define MCM VM
      community.libvirt.virt:
        command: define
        xml: "{{ mcm_xml.stdout }}"
      when: not mcm_exists

    - name: Get MCM disk path
      ansible.builtin.shell: virsh domblklist {{ vm_mcm_name }} | grep vda | awk '{print $2}'
      register: mcm_disk
      changed_when: false
      when: not mcm_exists

    - name: Create network config for MCM
      ansible.builtin.copy:
        dest: /tmp/ifcfg-{{ mcm_node.mgmt_interface }}
        content: |
          TYPE=Ethernet
          BOOTPROTO=static
          NAME=static-{{ mcm_node.mgmt_interface }}
          DEVICE={{ mcm_node.mgmt_interface }}
          ONBOOT=yes
          IPADDR={{ mcm_node.mgmt_ip }}
          PREFIX={{ mcm_network_cidr_prefix }}
          GATEWAY={{ networks.management.gateway }}
          DNS1={{ networks.management.dns_servers[0] }}
          {% if networks.management.dns_servers | length > 1 %}
          DNS2={{ networks.management.dns_servers[1] }}
          {% endif %}
      when: not mcm_exists

    - name: Inject network config into MCM disk
      ansible.builtin.command:
        cmd: virt-copy-in -a {{ mcm_disk.stdout }} /tmp/ifcfg-{{ mcm_node.mgmt_interface }} /etc/sysconfig/network-scripts/
      environment:
        LIBGUESTFS_BACKEND: direct
      when: not mcm_exists

    - name: Remove temporary network config file for MCM
      ansible.builtin.file:
        path: /tmp/ifcfg-{{ mcm_node.mgmt_interface }}
        state: absent

    - name: Start MCM VM
      community.libvirt.virt:
        name: "{{ vm_mcm_name }}"
        state: running
        autostart: yes
      when: not mcm_exists
      register: mcm_start

    # ---------- OSMS ----------
    - name: Check if OSMS VM already exists
      ansible.builtin.set_fact:
        osms_exists: "{{ vm_osms_name in existing_vms.stdout_lines }}"

    - name: Create VM - OSMS
      ansible.builtin.command:
        cmd: >
          virt-install
          --name {{ vm_osms_name }}
          --memory {{ vm_osms_memory }}
          --vcpus {{ vm_osms_vcpus }}
          --cpu host-passthrough
          --disk size={{ vm_osms_disk_size }},backing_store="{{ images_dir}}/9_5_hardened_image_vm.qcow2"
          --os-variant rhel9.5
          --network bridge=br-mgmt,model=virtio
          --import
          --noautoconsole
          --graphics vnc
          --boot uefi
          --print-xml
      register: osms_xml
      when: not osms_exists

    - name: Define OSMS VM
      community.libvirt.virt:
        command: define
        xml: "{{ osms_xml.stdout }}"
      when: not osms_exists

    - name: Get OSMS disk path
      ansible.builtin.shell: virsh domblklist {{ vm_osms_name }} | grep vda | awk '{print $2}'
      register: osms_disk
      changed_when: false
      when: not osms_exists

    - name: Create network config for OSMS
      ansible.builtin.copy:
        dest: /tmp/ifcfg-{{ osms_node.mgmt_interface }}
        content: |
          TYPE=Ethernet
          BOOTPROTO=static
          NAME=static-{{ osms_node.mgmt_interface }}
          DEVICE={{ osms_node.mgmt_interface }}
          ONBOOT=yes
          IPADDR={{ osms_node.mgmt_ip }}
          PREFIX={{ mcm_network_cidr_prefix }}
          GATEWAY={{ networks.management.gateway }}
          DNS1={{ networks.management.dns_servers[0] }}
          {% if networks.management.dns_servers | length > 1 %}
          DNS2={{ networks.management.dns_servers[1] }}
          {% endif %}
      when: not osms_exists

    - name: Inject network config into OSMS disk
      ansible.builtin.command:
        cmd: virt-copy-in -a {{ osms_disk.stdout }} /tmp/ifcfg-{{ osms_node.mgmt_interface }} /etc/sysconfig/network-scripts/
      environment:
        LIBGUESTFS_BACKEND: direct
      when: not osms_exists

    - name: Remove temporary network config file for OSMS
      ansible.builtin.file:
        path: /tmp/ifcfg-{{ osms_node.mgmt_interface }}
        state: absent

    - name: Start OSMS VM
      community.libvirt.virt:
        name: "{{ vm_osms_name }}"
        state: running
        autostart: yes
      when: not osms_exists
      register: osms_start

    # ---------- Wait for VMs and Run Partition Expansion ----------
    
    - name: Wait for MCM SSH to be available (initial boot)
      ansible.builtin.wait_for:
        host: "{{ mcm_node.mgmt_ip }}"
        port: 22
        delay: 60
        timeout: 600
      when: mcm_start is changed

    - name: Check MCM uptime to detect if hardening reboots are complete
      ansible.builtin.shell: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ssh.user }}@{{ mcm_node.mgmt_ip }} 'cat /proc/uptime | cut -d" " -f1 | cut -d"." -f1'
      register: mcm_uptime
      until: mcm_uptime.stdout | int > 300  # Uptime > 5 minutes means probably done rebooting
      retries: 20
      delay: 60
      when: mcm_start is changed
      changed_when: false

    - name: Run partition expansion on MCM
      ansible.builtin.shell: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ssh.user }}@{{ mcm_node.mgmt_ip }} 'bash -s' < {{ playbook_dir }}/scripts/expand-partitions.sh
      when: mcm_start is changed
      register: mcm_partition_result

    - name: Show MCM partition expansion results
      ansible.builtin.debug:
        var: mcm_partition_result.stdout_lines
      when: mcm_start is changed

    - name: Wait for OSMS SSH to be available (initial boot)
      ansible.builtin.wait_for:
        host: "{{ osms_node.mgmt_ip }}"
        port: 22
        delay: 60
        timeout: 600
      when: osms_start is changed

    - name: Check OSMS uptime to detect if hardening reboots are complete
      ansible.builtin.shell: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ssh.user }}@{{ osms_node.mgmt_ip }} 'cat /proc/uptime | cut -d" " -f1 | cut -d"." -f1'
      register: osms_uptime
      until: osms_uptime.stdout | int > 300  # Uptime > 5 minutes means probably done rebooting
      retries: 20
      delay: 60
      when: osms_start is changed
      changed_when: false

    - name: Run partition expansion on OSMS
      ansible.builtin.shell: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ ssh.user }}@{{ osms_node.mgmt_ip }} 'bash -s' < {{ playbook_dir }}/scripts/expand-partitions.sh
      when: osms_start is changed
      register: osms_partition_result

    - name: Show OSMS partition expansion results
      ansible.builtin.debug:
        var: osms_partition_result.stdout_lines
      when: osms_start is changed
