---
- name: Generate OPNsense config from template with variable replacement
  hosts: localhost
  
  vars:
    env_name: "{{ env_name | mandatory }}"
    template_file: "/install/data/templates/opnsense/config_template.xml"
    output_dir: "/install/usr_home/{{ env_name }}/generated_files"
    output_file: "{{ output_dir }}/config.xml"
  vars_files:
    - "/install/usr_home/{{ env_name }}/group_vars/vms.yml"
  
  tasks:
    
    - name: Ensure output directory exists
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
    
    - name: Read template file
      slurp:
        src: "{{ template_file }}"
      register: template_content
    
    - name: Replace variables in template
      copy:
        content: |
          {{ template_content.content | b64decode | 
             regex_replace('__OSDC1_MAC__', hostvars['osdc1'].mac_address) |
             regex_replace('__WAN_IP__', opnsense_cfg.wan_ip) |
             regex_replace('__WAN_GATEWAY__', customer_network.gateway) |
             regex_replace('__WAN_SUBNET__', customer_network.cidr | regex_replace('^/', '')) |
             regex_replace('__NTP_TIMESERVERS__', ntp.server) |
             regex_replace('__NTP_PREFER__', ntp.server) |
             regex_replace('__OPNSENSE_HOSTNAME__', opnsense_cfg.hostname) |
             regex_replace('__OPNSENSE_DOMAIN__', domain_name) |
             regex_replace('__INTERFACE_WAN__', opnsense_cfg.wan_interface) |
             regex_replace('__INTERFACE_LAN__', opnsense_cfg.lan_interface) |
             regex_replace('__INTERFACE_OPT1__', opnsense_cfg.opt1_interface) }}
        dest: "{{ output_file }}"
        mode: '0644'

- name: Copy files to mgmt_kvm
  hosts: mgmt_kvm
  vars:
    env_name: "{{ env_name | mandatory }}"
    output_dir: "/install/usr_home/{{ env_name }}/generated_files"
    output_file: "{{ output_dir }}/config.xml"

  tasks:

    - name: Copy generated config to mgmt_kvm
      copy:
        src: "{{ output_file }}"
        dest: "/var/lib/libvirt/config/vm_config/opnsense/config.xml"
        mode: '0644'

    - name: Copy install script to mgmt_kvm
      copy:
        src: "/install/data/tasks/basekit/install_opnsense.sh"
        dest: "/var/lib/libvirt/config/vm_config/opnsense/opnsense_install.sh"
        mode: '0755'