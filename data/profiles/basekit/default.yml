# Base-Kit Default Profile
# This profile deploys a management KVM server and creates VMs for OpenSpace infrastructure
# All configuration comes from usr_home/{env}/group_vars/

metadata:
  name: "Base-Kit Default"
  version: "1.0.0"
  description: "Deploys management KVM server with MCM, OSMS, and OPNsense VMs"
  profile_kind: basekit
  
requirements:
  # Inventory must have these host groups
  inventory_groups:
    - mgmt_kvm
    - vms
  
  # Environment files that must exist
  files:
    - "/install/usr_home/{env}/.ssh/onboarder_ssh_key.pub"

steps:
  - id: copy_ssh_key
    description: "Copy SSH Key to mgmt_kvm"
    kind: ansible
    file: "tasks/common/copy_ssh_key.yml"
    args:
      - "-e env_name={env}"
      - "-e target_hosts=mgmt_kvm"
      - "-e ssh_pubkey_path=/install/usr_home/{env}/.ssh/onboarder_ssh_key.pub"
    on_failure: fail
    required: true

  - id: bootstrap_mgmt_kvm
    description: "Bootstrap Mgmt KVM"
    kind: ansible
    file: "tasks/basekit/bootstrap-mgmt-kvm.yml"
    on_failure: fail
    required: true
    timeout: 1800

  - id: deploy_vms
    description: "Deploy VMs"
    kind: ansible
    file: "tasks/basekit/deploy-vms.yml"
    on_failure: fail
    required: true
    timeout: 3600

  - id: configure_mcm
    description: "Configure MCM"
    kind: ansible
    file: "tasks/common/configure-node.yml"
    args:
      - "-e env_name={env}"
      - "-e target_hosts=mcm"
    on_failure: fail
    required: true
    timeout: 1800

  - id: configure_osms
    description: "Configure OSMS"
    kind: ansible
    file: "tasks/common/configure-node.yml"
    args:
      - "-e env_name={env}"
      - "-e target_hosts=osms"
    on_failure: fail
    required: true
    timeout: 1800

# TODO
#  - id: generate_opnsense_config
#    description: "Generate OPNsense Configuration"
#    kind: ansible
#    file: "tasks/basekit/generate-opnsense-config.yml"
#    args:
#      - "-e env_name={env}"
#    on_failure: fail
#    required: true
#    timeout: 300

  - id: configure_opnsense_config.xml
    description: "Configure OPNsense config.xml"
    kind: ansible
    file: "tasks/basekit/configure-opnsense.yml"
    args:
      - "-e env_name={env}"
      - "-e /install/usr_home/{env}/group_vars/vms.yml"
    on_failure: fail
    required: true
    timeout: 600

  - id: deploy_opnsense
    description: "Deploy OPNsense"
    kind: ansible
    file: "tasks/basekit/deploy-opnsense.yml"
    on_failure: fail
    required: true
    timeout: 1800

#  - id: Kratos Power Scripts (step 15 in instructions)