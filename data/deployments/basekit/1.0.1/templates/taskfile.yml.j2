# ==============================================================================
# Environment Taskfile - GENERATED FILE
# ==============================================================================
# ⚠️  DO NOT EDIT THIS FILE MANUALLY
#
# This file is GENERATED from: deployment.yml
# To make changes:
#   1. Edit deployment.yml
#   2. Run: task prep-config
#   3. This file will be regenerated
#
# Generated: {{ ansible_date_time.iso8601 }}
# Deployment: {{ deployment.name }}
# ==============================================================================

version: '3'

vars:
  DEPLOYMENT_NAME: "{{ deployment.name }}"
  DEPLOYMENT_TYPE: "{{ deployment.type }}"
  DEPLOYMENT_VERSION: "{{ deployment.version }}"
  ONBOARDER_VERSION: "{{ deployment.onboarder_version }}"

includes:
  deploy:
    taskfile: /docker-workspace/data/deployments/{{ deployment.type }}/{{ deployment.version }}/main.yml
    dir: /docker-workspace/config/{{ deployment.name }}

tasks:
  # ============================================================================
  # Configuration Management
  # ============================================================================
  prep-config:
    desc: "Regenerate all configuration files from deployment.yml"
    cmds:
      - python3 /docker-workspace/data/run_task.py 
          --task-id=prep-config 
          --hosts=localhost 
          --file=/docker-workspace/data/deployments/{{ deployment.type }}/{{ deployment.version }}/tasks/generate_config.yml
          --kind=ansible
          --extra-vars="env_name={{ deployment.name }}"
    silent: false

  validate-config:
    desc: "Validate generated configuration files"
    cmds:
      - echo "Validating Ansible inventory..."
      - ansible-inventory -i config.yml --list > /dev/null
      - echo "✓ Ansible inventory is valid"
      - echo "Validating group_vars YAML..."
      - python3 -c "import yaml; yaml.safe_load(open('group_vars/all.yml'))"
      - python3 -c "import yaml; yaml.safe_load(open('group_vars/deployment.yml'))"
      - echo "✓ group_vars YAML is valid"
      - echo "Validating host_vars YAML..."
      - python3 -c "import yaml; yaml.safe_load(open('host_vars/mgmt_kvm.yml'))"
      - echo "✓ host_vars YAML is valid"
      - echo ""
      - echo "✅ All configuration files are valid!"

  show-config:
    desc: "Display current configuration summary"
    cmds:
      - |
        echo "╔════════════════════════════════════════════════════════════════╗"
        echo "║             Configuration Summary                              ║"
        echo "╚════════════════════════════════════════════════════════════════╝"
        echo ""
        echo "Deployment: {{ deployment.name }}"
        echo "Type: {{ deployment.type }}"
        echo "Version: {{ deployment.version }}"
        echo "Onboarder: {{ deployment.onboarder_version }}"
        echo ""
        echo "Configuration Files:"
        echo "  Source: deployment.yml"
        echo "  Generated: config.yml, group_vars/, host_vars/"
        echo ""
        echo "Clusters:"
{% if clusters.management_cluster is defined %}
{% for cluster in clusters.management_cluster.clusters %}
        echo "  - {{ cluster.cluster_name }} (MCM)"
{% endfor %}
{% endif %}
{% if clusters.openspace_management_system is defined %}
{% for cluster in clusters.openspace_management_system.clusters %}
        echo "  - {{ cluster.cluster_name }} (OSMS)"
{% endfor %}
{% endif %}
{% if clusters.openspace_datapath_cluster is defined %}
{% for cluster in clusters.openspace_datapath_cluster.clusters %}
        echo "  - {{ cluster.cluster_name }} (OSDC)"
{% endfor %}
{% endif %}
        echo ""

  # ============================================================================
  # Preparation Tasks
  # ============================================================================
  prep:
    desc: "Complete environment preparation (generates configs, prepares container, etc)"
    cmds:
      - task: prep-config
      - task: deploy:prep-onboarder-container
      - task: deploy:run-deployment-setup

  prep-onboarder-container:
    desc: "Prepare onboarder container"
    cmds:
      - task: deploy:prep-onboarder-container

  # ============================================================================
  # Deployment Tasks
  # ============================================================================
  deploy-mcm:
    desc: "Deploy MCM (Management Cluster Manager)"
    cmds:
      - task: deploy:deploy-mcm

  deploy-osms:
    desc: "Deploy OSMS (OpenSpace Management System)"
    cmds:
      - task: deploy:deploy-osms

  deploy-osdc:
    desc: "Deploy OSDC (OpenSpace Data Cluster)"
    cmds:
      - task: deploy:deploy-osdc

  deploy-all:
    desc: "Deploy all clusters (MCM → OSMS → OSDC)"
    cmds:
      - task: deploy-mcm
      - task: deploy-osms
      - task: deploy-osdc

  # ============================================================================
  # Cleanup Tasks
  # ============================================================================
  clean:
    desc: "Clean up deployment artifacts"
    cmds:
      - task: deploy:clean

  clean-config:
    desc: "Remove all generated configuration files"
    prompt: "This will delete all generated config files. Continue?"
    cmds:
      - rm -f config.yml
      - rm -f Taskfile.yml
      - rm -rf group_vars/
      - rm -rf host_vars/
      - rm -rf .cache/generated/
      - echo "✓ Generated configuration files removed"
      - echo "Run 'task prep-config' to regenerate"

  # ============================================================================
  # Utility Tasks
  # ============================================================================
  shell:
    desc: "Open a shell in the onboarder container"
    cmds:
      - task: deploy:shell

  logs:
    desc: "Show deployment logs"
    cmds:
      - cat .cache/state.json | python3 -m json.tool

  help:
    desc: "Show this help message"
    cmds:
      - task --list

# ==============================================================================
# Common Commands Quick Reference
# ==============================================================================
#
# Configuration:
#   task prep-config         - Regenerate configs from deployment.yml
#   task validate-config     - Validate generated configs
#   task show-config         - Show config summary
#
# Deployment:
#   task prep                - Complete environment preparation
#   task deploy-mcm          - Deploy MCM cluster
#   task deploy-osms         - Deploy OSMS cluster
#   task deploy-osdc         - Deploy OSDC cluster
#   task deploy-all          - Deploy all clusters
#
# Utilities:
#   task shell               - Open container shell
#   task logs                - View logs
#   task clean               - Clean deployment artifacts
#
# ==============================================================================
